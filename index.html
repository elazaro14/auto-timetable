<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Official School Timetable 2026 - Load Analysis</title>
    <style>
        :root { --row-height: 45px; --font-size: 11px; --cell-padding: 5px; --primary: #2c3e50; }
        .compact-mode { --row-height: 30px; --font-size: 9px; --cell-padding: 2px; }

        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7f6; margin: 0; padding: 10px; }
        .container { max-width: 1450px; margin: 0 auto; }
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        /* Header */
        .print-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        .logo-box { width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; }
        .logo-box img { max-height: 100%; max-width: 100%; object-fit: contain; }
        .header-text { text-align: center; flex-grow: 1; }
        .header-text h1 { margin: 0; font-size: 24px; color: var(--primary); text-transform: uppercase; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 25px; table-layout: fixed; }
        th, td { border: 1px solid #333; padding: var(--cell-padding); text-align: center; font-size: var(--font-size); height: var(--row-height); }
        th { background: var(--primary); color: white; }
        
        .day-title { background: #34495e; color: white; padding: 10px; font-size: 16px; text-align: center; margin: 20px 0 5px; border-radius: 4px; }
        .break-cell { background: #dfe6e9 !important; font-weight: bold; writing-mode: vertical-rl; text-orientation: mixed; font-size: 9px; width: 30px !important; }
        
        /* Load Specific Styling */
        .load-table { table-layout: auto !important; width: 80%; margin: 10px auto; border: 2px solid var(--primary); }
        .load-table th { background: #ecf0f1; color: #2c3e50; border: 1px solid #bdc3c7; }
        .load-summary-title { text-align: center; color: var(--primary); margin: 30px 0 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .overload-warning { color: #e74c3c; font-weight: bold; }

        .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button, select { padding: 10px 15px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; font-weight: bold; }
        .btn-main { background: #27ae60; color: white; border: none; }
        .view-bar { background: #ecf0f1; padding: 15px; border-radius: 8px; display: none; margin-top: 10px; text-align: center; gap: 10px; }

        @media print {
            .no-print, .panel, .view-bar { display: none !important; }
            body { background: white; }
            .day-section { page-break-after: always; }
            .load-summary-section { page-break-before: always; }
        }
    </style>
</head>
<body id="mainBody">

<div class="panel container no-print">
    <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 15px;">
        <input type="file" id="logoUpload" accept="image/*" hidden onchange="processLogo(event)">
        <button onclick="document.getElementById('logoUpload').click()" style="background:#34495e; color:white;">Upload Logo</button>
        <input type="text" id="schoolName" placeholder="SCHOOL NAME" style="font-size: 18px; width: 300px; border: none; border-bottom: 2px solid #333; text-align:center;">
    </div>

    <div class="controls">
        <input type="file" id="csvFile" accept=".csv" hidden onchange="handleCsv(event)">
        <button onclick="document.getElementById('csvFile').click()" style="background:#2980b9; color:white;">1. Load CSV</button>
        <button class="btn-main" id="genBtn" onclick="generate()" disabled>2. Generate & Analyze Load</button>
        <button onclick="window.print()" style="background:#2d3436; color:white;">Print All</button>
    </div>
    
    <div class="view-bar" id="viewBar">
        <button onclick="renderMaster()">Master View</button>
        <select id="selClass" onchange="renderIndividual('class')"><option value="">-- View Class --</option></select>
        <select id="selTeacher" onchange="renderIndividual('teacher')"><option value="">-- View Teacher --</option></select>
        <button onclick="renderLoadReport()" style="background:#8e44ad; color:white;">Teacher Load Report</button>
    </div>
</div>

<div id="output" class="container"></div>

<script>
const DAYS = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"];
const PERIODS = [
    {p:"P1", t:"8:00"}, {p:"P2", t:"8:40"}, {p:"P3", t:"9:20"}, {p:"P4", t:"10:00"},
    {p:"TEA", isBreak: true},
    {p:"P5", t:"11:10"}, {p:"P6", t:"11:50"}, {p:"P7", t:"12:30"}, {p:"P8", t:"13:10"}, {p:"P9", t:"13:50"}
];

let rawData = [], timetable = [], logoData = "";

function getSubColor(s) {
    let hash = 0;
    for (let i = 0; i < s.length; i++) hash = s.charCodeAt(i) + ((hash << 5) - hash);
    return `hsl(${Math.abs(hash % 360)}, 75%, 93%)`;
}

function processLogo(e) {
    const reader = new FileReader();
    reader.onload = (ev) => { logoData = ev.target.result; };
    reader.readAsDataURL(e.target.files[0]);
}

function handleCsv(e) {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const lines = ev.target.result.split('\n').slice(1).filter(l => l.trim());
        rawData = lines.map(l => {
            const p = l.split(',');
            return { subject: p[0].trim().toUpperCase(), teacher: p[1].trim(), form: p[3].trim().toUpperCase() };
        });
        document.getElementById('genBtn').disabled = false;
        populateDropdowns();
    };
    reader.readAsText(e.target.files[0]);
}

function populateDropdowns() {
    const ts = [...new Set(rawData.map(x => x.teacher))].sort();
    const fs = [...new Set(rawData.map(x => x.form))].sort();
    document.getElementById('selTeacher').innerHTML = '<option value="">-- Teacher --</option>' + ts.map(t => `<option value="${t}">${t}</option>`).join('');
    document.getElementById('selClass').innerHTML = '<option value="">-- Class --</option>' + fs.map(f => `<option value="${f}">${f}</option>`).join('');
}

function generate() {
    timetable = [];
    const pool = JSON.parse(JSON.stringify(rawData));
    const forms = [...new Set(pool.map(x => x.form))].sort();

    DAYS.forEach(day => {
        PERIODS.forEach(per => {
            if(per.isBreak) return;
            forms.forEach(f => {
                const idx = pool.findIndex(l => 
                    l.form === f && 
                    !timetable.some(t => t.day === day && t.period === per.p && (t.teacher === l.teacher || t.form === l.form))
                );
                if(idx !== -1) {
                    timetable.push({...pool[idx], day, period: per.p});
                    pool.splice(idx, 1);
                }
            });
        });
    });
    document.getElementById('viewBar').style.display = 'flex';
    renderMaster();
}

function getHeader(title) {
    const name = document.getElementById('schoolName').value || "SCHOOL TIMETABLE";
    const logo = logoData ? `<img src="${logoData}">` : '';
    return `<div class="print-header"><div class="logo-box">${logo}</div><div class="header-text"><h1>${name}</h1><h2>${title}</h2></div><div class="logo-box"></div></div>`;
}

function renderMaster() {
    let html = getHeader("MASTER TIMETABLE");
    const forms = [...new Set(timetable.map(x => x.form))].sort();
    DAYS.forEach(day => {
        html += `<div class="day-section"><div class="day-title">${day}</div><table><tr><th>STREAM</th>`;
        PERIODS.forEach(p => html += `<th>${p.p}${p.t ? '<br><small>'+p.t+'</small>' : ''}</th>`);
        html += `</tr>`;
        forms.forEach(f => {
            html += `<tr><td style="font-weight:bold">${f}</td>`;
            PERIODS.forEach(p => {
                if(p.isBreak) html += `<td class="break-cell">BREAK</td>`;
                else {
                    const m = timetable.find(x => x.day === day && x.period === p.p && x.form === f);
                    html += `<td style="background:${m ? getSubColor(m.subject) : '#fff'}">${m ? `<b>${m.subject}</b><br>${m.teacher}` : ''}</td>`;
                }
            });
            html += `</tr>`;
        });
        html += `</table></div>`;
    });
    document.getElementById('output').innerHTML = html;
}

function renderIndividual(type) {
    const val = type === 'class' ? document.getElementById('selClass').value : document.getElementById('selTeacher').value;
    if(!val) return;
    let html = getHeader(`${type.toUpperCase()} VIEW: ${val}`);
    html += `<table><tr><th>DAY</th>`;
    PERIODS.forEach(p => html += `<th>${p.p}</th>`);
    html += `</tr>`;
    DAYS.forEach(day => {
        html += `<tr><td style="font-weight:bold">${day}</td>`;
        PERIODS.forEach(p => {
            if(p.isBreak) html += `<td class="break-cell">BREAK</td>`;
            else {
                const m = timetable.find(x => x.day === day && x.period === p.p && (type==='class'? x.form===val : x.teacher===val));
                html += `<td style="background:${m ? getSubColor(m.subject) : '#fff'}">${m ? `<b>${m.subject}</b><br>${type==='class' ? m.teacher : m.form}` : ''}</td>`;
            }
        });
        html += `</tr>`;
    });
    document.getElementById('output').innerHTML = html + "</table>";
}

function renderLoadReport() {
    let html = getHeader("TEACHER LOAD ANALYSIS");
    const loads = {};
    const details = {};

    rawData.forEach(r => {
        loads[r.teacher] = (loads[r.teacher] || 0) + 1;
        if(!details[r.teacher]) details[r.teacher] = [];
        details[r.teacher].push(`${r.subject} (${r.form})`);
    });

    html += `<div class="load-summary-section"><h3 class="load-summary-title">Weekly Period Distribution</h3><table class="load-table">`;
    html += `<thead><tr><th>Teacher Name</th><th>Subjects & Classes</th><th>Total Periods/Wk</th></tr></thead><tbody>`;
    
    Object.keys(loads).sort().forEach(t => {
        const uniqueDetails = [...new Set(details[t])].join(', ');
        const isOver = loads[t] > 30 ? 'overload-warning' : '';
        html += `<tr><td><b>${t}</b></td><td style="text-align:left; padding-left:15px;">${uniqueDetails}</td><td class="${isOver}">${loads[t]}</td></tr>`;
    });
    
    html += `</tbody></table></div>`;
    document.getElementById('output').innerHTML = html;
}
</script>
</body>
</html>
