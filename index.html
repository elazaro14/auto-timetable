<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Timetable 2026 - Robust Version</title>
<style>
    body { font-family: Arial, Helvetica, sans-serif; background: #f8f9fa; margin: 0; padding: 12px; color: #222; }
    .container { max-width: 1380px; margin: 0 auto; }
    .panel { background: white; padding: 14px; border-radius: 8px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); margin-bottom: 18px; }
    button, input, select { padding: 6px 12px; font-size: 13px; border-radius: 5px; border: 1px solid #ccc; margin: 3px; }
    .master-timetable, .individual-timetable { width: 100%; border-collapse: collapse; font-size: 10px; background: white; margin: 10px 0 20px; line-height: 1.15; }
    th, td { border: 1px solid #666; padding: 3px 4px; text-align: center; height: 26px; }
    th { background: #2c3e50; color: white; font-weight: normal; font-size: 9.5px; }
    .break-cell { background: #f1f3f5; color: #444; font-weight: bold; font-size: 9px; width: 60px; }
    .fixed { background: #e3f2fd; color: #0d47a1; font-weight: bold; font-size: 9px; }
    .group-separator td { background: #ffcc00; height: 5px; padding: 0; border: none; }
    .day-title { background: #34495e; color: white; padding: 8px; font-size: 1.2em; margin: 18px 0 6px; text-align: center; border-radius: 5px; }
    .form-col { font-weight: bold; width: 52px; font-size: 10.5px; }
    .time-small { font-size: 8px; color: #ddd; display: block; margin-top: 1px; }
    .lesson-subject { font-size: 10px; }
    .lesson-teacher { font-size: 8.5px; color: #444; display: block; margin-top: 1px; }
    .view-controls { margin: 15px 0; padding: 10px; background: #f1f3f5; border-radius: 6px; display: none; }
    .error { color: #c00; font-weight: bold; }
    @media print { .panel, .view-controls { display: none !important; } body { padding: 0; margin: 0; } }
</style>
</head>
<body>

<div class="panel container">
    <h2 style="margin:0 0 12px 0; text-align:center">School Timetable Generator 2026</h2>
    
    <div style="text-align:center; margin:12px 0;">
        <input id="school" placeholder="School Name" style="width:220px">
        <input id="year" placeholder="Year" style="width:100px">
        <select id="display">
            <option value="subject">Subject only</option>
            <option value="full" selected>Subject + Teacher</option>
        </select>
    </div>

    <div style="text-align:center;">
        <button onclick="document.getElementById('csv').click()" class="blue">Upload CSV</button>
        <input type="file" id="csv" accept=".csv" hidden onchange="loadCSV(event)">
        <button onclick="generate()" class="green" id="genBtn" disabled>Generate Timetable</button>
        <button onclick="window.print()" class="gray">Print Current View</button>
    </div>

    <div class="view-controls" id="viewControls">
        <strong>View:</strong>
        <button onclick="renderMaster()">Full Master View</button>
        <select id="streamSelect" onchange="renderStream()"><option value="">-- Select Stream --</option></select>
        <select id="teacherSelect" onchange="renderTeacher()"><option value="">-- Select Teacher --</option></select>
    </div>

    <p id="status" style="margin-top:12px; font-weight:bold; text-align:center">
        Upload your CSV file (Subject,Teacher,Room,Form)
    </p>
</div>

<div class="container" id="output"></div>

<script>
const DAYS = ["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY"];
const PERIODS = [
    {c:"P1",t:"8:00-8:40"},{c:"P2",t:"8:40-9:20"},{c:"P3",t:"9:20-10:00"},
    {c:"P4",t:"10:00-10:40"},{c:"BREAK",t:"10:40-11:10"},
    {c:"P5",t:"11:10-11:50"},{c:"P6",t:"11:50-12:30"},{c:"P7",t:"12:30-13:10"},
    {c:"P8",t:"13:10-13:50"},{c:"P9",t:"13:50-14:30"}
];

const DOUBLE_PAIRS = [['P1','P2'],['P2','P3'],['P3','P4'],['P5','P6'],['P6','P7'],['P7','P8'],['P8','P9']];

let lessonsDemand = [];
let timetable = [];
let allForms = [];
let allTeachers = new Set();

function isFixed(day, p) {
    if (day === "WEDNESDAY" && ["P8","P9"].includes(p)) return "RELIGION";
    if (day === "FRIDAY" && ["P7","P8","P9"].includes(p)) return "MOSQUE";
    return null;
}

function loadCSV(e) {
    const file = e.target.files[0];
    if (!file) return;

    document.getElementById("status").innerHTML = "Reading file...";
    
    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const lines = event.target.result.split("\n");
            if (lines.length < 2) throw new Error("File is empty or has no data rows");

            lessonsDemand = [];
            allTeachers.clear();

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(",");
                if (parts.length < 4) {
                    console.warn(`Skipping invalid row ${i+1}: too few columns`);
                    continue;
                }

                const subject = (parts[0] || "").trim();
                const teacher = (parts[1] || "").trim();
                const form    = (parts[3] || "").trim();

                if (!subject || !form) {
                    console.warn(`Skipping row ${i+1}: missing subject or form`);
                    continue;
                }

                lessonsDemand.push({ subject, teacher: teacher || null, form });
                if (teacher) allTeachers.add(teacher);
            }

            if (lessonsDemand.length === 0) {
                document.getElementById("status").innerHTML = 
                    '<span class="error">Error: No valid lessons found in CSV</span>';
                return;
            }

            allForms = [...new Set(lessonsDemand.map(l => l.form))].sort();

            document.getElementById("genBtn").disabled = false;
            document.getElementById("status").innerHTML = 
                `Success! Loaded <b>${lessonsDemand.length}</b> lessons • ` +
                `${allForms.length} classes • ${allTeachers.size} teachers`;
            
            console.log("Loaded lessons:", lessonsDemand.length);
        } catch (err) {
            document.getElementById("status").innerHTML = 
                `<span class="error">Error reading CSV: ${err.message}</span>`;
            console.error(err);
        }
    };
    reader.onerror = () => {
        document.getElementById("status").innerHTML = 
            '<span class="error">Failed to read file</span>';
    };
    reader.readAsText(file);
}

function generate() {
    if (lessonsDemand.length === 0) {
        alert("No valid data loaded. Please upload CSV first.");
        return;
    }

    // ... rest of the generation code remains the same ...
    // (the strict one-block-per-subject-per-day logic from previous version)
    
    // After successful generation:
    populateSelectors();
    renderMaster();
    document.getElementById("status").innerText = 
        `Generated successfully • ${timetable.length}/${lessonsDemand.length} periods placed`;
}

// Rest of the code (populateSelectors, renderMaster, renderStream, renderTeacher)
// remains exactly the same as in the previous version you had

// ... paste here the remaining functions from your last working version ...
</script>
</body>
</html>
