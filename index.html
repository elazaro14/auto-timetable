<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Official School Timetable 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --row-height: 45px; --font-size: 11px; --cell-padding: 5px; }
        .compact-mode { --row-height: 32px; --font-size: 9.5px; --cell-padding: 2px; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 1500px; margin: 0 auto; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .view-bar { background: #fff; padding: 15px; border-radius: 8px; display: none; margin-top: 15px; text-align: center; border: 1px solid #dfe3e8; }
        
        table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; margin-bottom: 30px; }
        th, td { border: 1px solid #bdc3c7; padding: var(--cell-padding); text-align: center; font-size: var(--font-size); height: var(--row-height); overflow: hidden; }
        th { background: #2c3e50; color: white; text-transform: uppercase; }
        
        .day-title { background: #34495e; color: white; padding: 10px; font-size: 18px; text-align: center; margin: 20px 0 0; border-radius: 6px 6px 0 0; font-weight: bold; }
        .break-cell { background: #ecf0f1; font-weight: bold; color: #7f8c8d; width: 30px !important; font-size: 9px; writing-mode: vertical-rl; text-orientation: mixed; }
        .unavailable-block { background: #fab1a0; color: #d63031; font-weight: bold; cursor: pointer; }
        
        button, select { padding: 10px 16px; border-radius: 6px; border: 1px solid #ced4da; cursor: pointer; font-weight: 600; }
        .btn-gen { background: #27ae60; color: white; border: none; }
        .btn-unavail { background: #e74c3c; color: white; border: none; }
        .btn-excel { background: #1f7244; color: white; border: none; }
        .btn-print { background: #34495e; color: white; border: none; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        @media print { 
            .panel, .view-bar, #loginOverlay, .controls { display: none !important; } 
            .day-title { background: #eee !important; color: #000 !important; border: 1px solid #000; }
            table { page-break-inside: avoid; }
        }
    </style>
</head>
<body id="mainBody">

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin-top:0; color:#2c3e50;">Admin Access</h2>
        <input type="email" id="loginEmail" placeholder="Email Address">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="handleLogin()" style="width:100%; background:#27ae60; color:white; border:none; padding:12px;">Sign In</button>
        <p id="loginMsg" style="color: #e74c3c; font-size: 13px; margin-top: 15px;"></p>
    </div>
</div>

<div class="panel container">
    <div class="controls">
        <input type="file" id="csvFile" accept=".csv" hidden onchange="handleUpload(event)">
        <button onclick="document.getElementById('csvFile').click()" style="background:#3498db; color:white;">Upload CSV</button>
        <button onclick="toggleUnavailabilityMode()" id="unavailBtn" class="btn-unavail">Set Unavailability</button>
        <select id="displayMode" onchange="renderMaster()">
            <option value="both">Subj + Teacher</option>
            <option value="subject">Subject Only</option>
        </select>
        <button onclick="startGeneration()" id="genBtn" class="btn-gen" disabled>Generate</button>
        <button onclick="saveToCloud()" id="saveCloudBtn" style="background:#f39c12; color:white; display:none;">Sync Cloud</button>
        <button onclick="exportToExcel()" class="btn-excel">Excel Download</button>
        <button onclick="window.print()" class="btn-print">Print PDF</button>
        <button onclick="handleLogout()" style="background:#95a5a6; color:white; margin-left:auto;">Logout</button>
    </div>

    <div class="view-bar" id="viewBar">
        <button onclick="renderMaster()">Master View</button>
        <select id="streamSelect" onchange="renderIndividual('stream')"><option value="">-- Class --</option></select>
        <select id="teacherSelect" onchange="renderIndividual('teacher')"><option value="">-- Teacher --</option></select>
        <button onclick="renderLoadSummary()">Load Summary</button>
    </div>
    
    <div id="status" style="text-align:center; font-weight:bold; font-size: 13px; margin-top:10px;"></div>
</div>

<div id="output" class="container"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDgbYVR98RE4ZLvkh6vb_dXvkmBRnvFf0w",
  authDomain: "school-timetable-6310b.firebaseapp.com",
  projectId: "school-timetable-6310b",
  storageBucket: "school-timetable-6310b.firebasestorage.app",
  messagingSenderId: "1057156909242",
  appId: "1:1057156909242:web:fdf3cf7a2706f098665a83"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const DAYS = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"];
const PERIODS = ["P1", "P2", "P3", "P4", "BREAK", "P5", "P6", "P7", "P8", "P9"];
const FORMS = ["F1A","F1B","F1C","F1D","F1E","F1F","F1G","F2A","F2B","F2C","F2D","F3A","F3B","F3C","F3D","F4A","F4B","F4C"];
let rawData = [], timetable = [], unavailableSlots = [];
let isUnavailMode = false;

function handleLogin() {
    auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value).catch(e => document.getElementById('loginMsg').innerText = e.message);
}
function handleLogout() { auth.signOut(); }
auth.onAuthStateChanged(user => {
    if (user) { document.getElementById('loginOverlay').style.display = 'none'; loadFromCloud(); }
    else { document.getElementById('loginOverlay').style.display = 'flex'; }
});

function handleUpload(e) {
    const reader = new FileReader();
    reader.onload = (event) => {
        const lines = event.target.result.split('\n').slice(1).filter(l => l.trim());
        rawData = lines.map(l => {
            const p = l.split(',');
            return { subject: p[0].trim(), teacher: p[1].trim(), form: p[3].trim() };
        });
        document.getElementById('genBtn').disabled = false;
    };
    reader.readAsText(e.target.files[0]);
}

async function loadFromCloud() {
    const doc = await db.collection("timetable_data").doc("active").get();
    if (doc.exists) {
        const data = doc.data();
        rawData = data.rawData || [];
        timetable = data.timetable || [];
        unavailableSlots = data.unavailableSlots || [];
        document.getElementById('viewBar').style.display = 'block';
        document.getElementById('saveCloudBtn').style.display = 'inline-block';
        document.getElementById('genBtn').disabled = (rawData.length === 0);
        populateFilters();
        renderMaster();
    }
}

async function saveToCloud() {
    await db.collection("timetable_data").doc("active").set({ rawData, timetable, unavailableSlots });
    document.getElementById('status').innerText = "âœ… Saved to Cloud.";
}

function startGeneration() {
    timetable = [];
    const slots = ["P1", "P2", "P3", "P4", "P5", "P6", "P7", "P8", "P9"];
    let groups = {};
    rawData.forEach(item => {
        let key = `${item.form}-${item.subject}`;
        if(!groups[key]) groups[key] = [];
        groups[key].push(item);
    });

    Object.values(groups).forEach(lessons => {
        let remaining = lessons.length;
        while(remaining > 0) {
            let placed = false;
            let isDouble = remaining >= 2;
            for(let a=0; a<400; a++) {
                let d = DAYS[Math.floor(Math.random()*5)];
                if(timetable.some(x => x.day === d && x.form === lessons[0].form && x.subject === lessons[0].subject)) continue;
                let pIdx = Math.floor(Math.random() * slots.length);
                let p1 = slots[pIdx];
                if(isDouble) {
                    let p2 = slots[pIdx + 1];
                    if(p2 && p1 !== "BREAK" && p2 !== "BREAK" && !unavailableSlots.includes(`${d}-${p1}-${lessons[0].form}`) && !unavailableSlots.includes(`${d}-${p2}-${lessons[0].form}`) &&
                       !timetable.some(x => x.day===d && x.period===p1 && (x.teacher===lessons[0].teacher || x.form===lessons[0].form)) &&
                       !timetable.some(x => x.day===d && x.period===p2 && (x.teacher===lessons[0].teacher || x.form===lessons[0].form))) {
                        if((p1 === "P4" && p2 === "P5") || (p2 === "P4" && p1 === "P5")) continue;
                        timetable.push({...lessons[0], day: d, period: p1}, {...lessons[0], day: d, period: p2});
                        remaining -= 2; placed = true; break;
                    }
                } else {
                    if(!unavailableSlots.includes(`${d}-${p1}-${lessons[0].form}`) && !timetable.some(x => x.day===d && x.period===p1 && (x.teacher===lessons[0].teacher || x.form===lessons[0].form))) {
                        let forbidden = p1 === "P4" ? "P5" : (p1 === "P5" ? "P4" : null);
                        if(forbidden && timetable.some(x => x.day === d && x.form === lessons[0].form && x.period === forbidden && x.subject === lessons[0].subject)) continue;
                        timetable.push({...lessons[0], day: d, period: p1});
                        remaining -= 1; placed = true; break;
                    }
                }
            }
            if(!placed) remaining--;
        }
    });
    renderMaster();
}

function renderMaster() {
    const mode = document.getElementById('displayMode').value;
    let html = "";
    DAYS.forEach(day => {
        html += `<div class="day-title">${day}</div><table><tr><th>STREAM</th>`;
        PERIODS.forEach(p => html += `<th>${p}</th>`);
        html += `</tr>`;
        FORMS.forEach(f => {
            html += `<tr><td><b>${f}</b></td>`;
            PERIODS.forEach(p => {
                if(p === "BREAK") html += `<td class="break-cell">TEA</td>`;
                else {
                    const m = timetable.find(x => x.day === day && x.period === p && x.form === f);
                    const isUn = unavailableSlots.includes(`${day}-${p}-${f}`);
                    let content = isUn ? 'BLOCKED' : (m ? (mode === 'both' ? `<b>${m.subject}</b><br>${m.teacher}` : `<b>${m.subject}</b>`) : '');
                    html += `<td class="${isUn ? 'unavailable-block' : ''}" onclick="markUnavailable('${day}','${p}','${f}')">${content}</td>`;
                }
            });
            html += `</tr>`;
        });
        html += `</table>`;
    });
    document.getElementById('output').innerHTML = html;
}

function toggleUnavailabilityMode() { isUnavailMode = !isUnavailMode; renderMaster(); }
function markUnavailable(d, p, f) { if(isUnavailMode) { const key = `${d}-${p}-${f}`; const idx = unavailableSlots.indexOf(key); if(idx > -1) unavailableSlots.splice(idx, 1); else unavailableSlots.push(key); renderMaster(); } }
function populateFilters() {
    const teachers = [...new Set(rawData.map(x => x.teacher))].sort();
    document.getElementById('teacherSelect').innerHTML = '<option value="">-- Teacher --</option>' + teachers.map(t => `<option value="${t}">${t}</option>`).join('');
    document.getElementById('streamSelect').innerHTML = '<option value="">-- Class --</option>' + FORMS.map(f => `<option value="${f}">${f}</option>`).join('');
}

function exportToExcel() {
    const wb = XLSX.utils.book_new();
    DAYS.forEach(day => {
        const rows = [["STREAM", ...PERIODS]];
        FORMS.forEach(f => {
            const row = [f];
            PERIODS.forEach(p => {
                if(p === "BREAK") row.push("TEA");
                else {
                    const m = timetable.find(x => x.day === day && x.period === p && x.form === f);
                    row.push(m ? `${m.subject} (${m.teacher})` : "");
                }
            });
            rows.push(row);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), day);
    });
    XLSX.writeFile(wb, "School_Timetable_2026.xlsx");
}

function renderIndividual(type) {
    const val = type === 'stream' ? document.getElementById('streamSelect').value : document.getElementById('teacherSelect').value;
    if(!val) return;
    let html = `<h2>${val} Schedule</h2><table><tr><th>DAY</th>`;
    PERIODS.forEach(p => html += `<th>${p}</th>`);
    html += `</tr>`;
    DAYS.forEach(day => {
        html += `<tr><td><b>${day}</b></td>`;
        PERIODS.forEach(p => {
            if(p === "BREAK") html += `<td class="break-cell">TEA</td>`;
            else {
                const m = timetable.find(x => x.day === day && x.period === p && (type === 'stream' ? x.form === val : x.teacher === val));
                html += `<td>${m ? `<b>${m.subject}</b><br>${type==='stream'?m.teacher:'Form: '+m.form}` : ''}</td>`;
            }
        });
        html += `</tr>`;
    });
    document.getElementById('output').innerHTML = html + `</table>`;
}

function renderLoadSummary() {
    const load = {};
    rawData.forEach(r => load[r.teacher] = (load[r.teacher] || 0) + 1);
    let html = `<h2>TEACHER LOAD</h2><table style="max-width:400px; margin:auto;"><tr><th>Teacher</th><th>Lessons</th></tr>`;
    Object.keys(load).sort().forEach(t => html += `<tr><td>${t}</td><td>${load[t]}</td></tr>`);
    document.getElementById('output').innerHTML = html + `</table>`;
}
</script>
</body>
</html>
