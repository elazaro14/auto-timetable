<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>School Timetable Generator</title>
<style>
 body{font-family:Arial}
 table{border-collapse:collapse;width:100%}
 th,td{border:1px solid #000;padding:4px;text-align:center}
 th{background:#eee}
 select,button,input{margin:4px}
</style>
</head>

<body>

<h2 id="schoolTitle">School Timetable</h2>

<input id="schoolName" placeholder="School Name">
<input id="year" placeholder="Academic Year">
<button onclick="applyHeader()">Apply</button>
<br><br>

<input type="file" id="csv">
<button id="gen" disabled>Generate Timetable</button>

<hr>

<select id="view">
<option value="master">Master</option>
<option value="stream">Stream</option>
<option value="teacher">Teacher</option>
</select>

<select id="filter"></select>

<table id="tt"></table>

<script>
const days=["Mon","Tue","Wed","Thu","Fri"];
const periods=["P1","P2","P3","P4","P5","P6","P7","P8"];

let data=[],finalTT=[];

csv.onchange=e=>loadCSV(e);
gen.onclick=generate;
view.onchange=render;

function applyHeader(){
 schoolTitle.textContent=
  schoolName.value+" â€” "+year.value;
}

/* ---------- LOAD CSV ---------- */
function loadCSV(e){
 const r=new FileReader();
 r.onload=()=>{
  data=r.result.split("\n").slice(1)
   .filter(x=>x.trim())
   .map(l=>{
    let p=l.split(",");
    return{
     subject:p[0].trim(),
     teacher:p[1].trim(),
     form:p[2].trim()
    };
   });
  gen.disabled=false;
 };
 r.readAsText(e.target.files[0]);
}

/* ---------- GENERATE ---------- */
function generate(){
 finalTT=[];
 const forms=[...new Set(data.map(x=>x.form))];

 forms.forEach(f=>{
  let lessons=data.filter(x=>x.form===f);
  let weekly=[...lessons];
  let used={};

  days.forEach(d=>{
   shuffle(weekly);

   weekly.forEach(l=>{
    let key=`${d}-${l.subject}`;
    if(used[key]) return;

    let p=pickPeriod(f,d,l.subject);
    if(!p) return;

    finalTT.push({
     day:d,period:p,form:f,
     subject:l.subject,teacher:l.teacher
    });
    used[key]=true;

    /* try double */
    if(pickDouble(f,d,l.subject,p)){
     let p2=periods[periods.indexOf(p)+1];
     finalTT.push({
      day:d,period:p2,form:f,
      subject:l.subject,teacher:l.teacher
     });
    }
   });
  });
 });

 render();
}

/* ---------- PERIOD PICK ---------- */
function pickPeriod(form,day,subject){
 let usedToday=finalTT.filter(x=>
  x.form===form && x.day===day &&
  x.subject===subject
 ).length;

 if(usedToday>=1) return null;

 let avoid=finalTT.filter(x=>
  x.form===form && x.subject===subject
 ).map(x=>x.period);

 let free=periods.filter(p=>
  !finalTT.find(x=>x.form===form && x.day===day && x.period===p) &&
  !avoid.includes(p)
 );

 return free.length ? free[Math.floor(Math.random()*free.length)] : null;
}

/* ---------- DOUBLE CHECK ---------- */
function pickDouble(form,day,subject,p){
 let i=periods.indexOf(p);
 if(i>=periods.length-1) return false;

 let next=periods[i+1];
 let count=finalTT.filter(x=>
  x.form===form && x.day===day &&
  x.subject===subject
 ).length;

 if(count!==1) return false;

 if(finalTT.find(x=>x.form===form && x.day===day && x.period===next))
  return false;

 return Math.random()<0.6;
}

/* ---------- RENDER ---------- */
function render(){
 const t=document.getElementById("tt");
 t.innerHTML="";

 let head="<tr><th>Day</th>";
 periods.forEach(p=>head+=`<th>${p}</th>`);
 head+="</tr>";
 t.innerHTML+=head;

 days.forEach(d=>{
  let r=`<tr><th>${d}</th>`;
  periods.forEach(p=>{
   let c=finalTT.find(x=>x.day===d && x.period===p);
   r+=`<td>${c?c.subject:""}</td>`;
  });
  r+="</tr>";
  t.innerHTML+=r;
 });
}

/* ---------- UTIL ---------- */
function shuffle(a){
 for(let i=a.length-1;i>0;i--){
  let j=Math.floor(Math.random()*(i+1));
  [a[i],a[j]]=[a[j],a[i]];
 }
}
</script>

</body>
</html>
