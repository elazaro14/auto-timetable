<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Official School Timetable 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --row-height: 48px; --font-size: 11px; --cell-padding: 4px; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 1550px; margin: 0 auto; }
        .panel { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        
        .header-info { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; }
        .header-info input { border: none; border-bottom: 2px solid #2c3e50; font-weight: bold; font-size: 18px; text-align: center; width: 300px; outline: none; background: transparent; }
        
        .controls { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
        .view-bar { background: #fff; padding: 12px; border-radius: 8px; display: none; text-align: center; border: 1px solid #ddd; margin-top:10px; }
        
        table { width: 100%; border-collapse: collapse; background: white; table-layout: fixed; }
        th, td { border: 1px solid #999; padding: var(--cell-padding); text-align: center; font-size: var(--font-size); height: var(--row-height); overflow: hidden; }
        th { background: #2c3e50; color: white; line-height: 1.2; }
        th small { display: block; font-size: 9px; color: #ecf0f1; font-weight: normal; }
        
        /* Narrow Form Separator */
        .form-separator { background: #2c3e50 !important; height: 4px !important; padding: 0 !important; border: none !important; }
        
        .day-title { background: #34495e; color: white; padding: 8px; font-size: 16px; text-align: center; margin: 20px 0 0; font-weight: bold; border-radius: 4px 4px 0 0; }
        .break-cell { background: #dfe6e9; font-weight: bold; color: #636e72; width: 22px !important; font-size: 8px; writing-mode: vertical-rl; text-orientation: mixed; padding: 0; }
        .religion-cell { background: #dff9fb; color: #0984e3; font-weight: bold; font-size: 10px; }
        .friday-strip { background: #636e72 !important; padding: 0; pointer-events: none; }
        .unavailable-block { background: #fab1a0; color: #d63031; font-weight: bold; }
        
        button, select { padding: 8px 14px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; font-weight: 600; font-size: 12px; }
        .btn-gen { background: #27ae60; color: white; border: none; }
        .btn-unavail { background: #e74c3c; color: white; border: none; }
        .btn-excel { background: #1f7244; color: white; border: none; }

        @media print { 
            .panel, .view-bar, #loginOverlay, .controls { display: none !important; } 
            .day-title { background: #eee !important; color: #000 !important; border: 1px solid #000; }
            .form-separator { background: #000 !important; height: 2px !important; }
        }
    </style>
</head>
<body>

<div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(44,62,80,0.98); display:flex; justify-content:center; align-items:center; z-index:10000;">
    <div style="background:white; padding:30px; border-radius:8px; width:300px; text-align:center;">
        <h3>Admin Login</h3>
        <input type="email" id="loginEmail" placeholder="Email" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd;">
        <input type="password" id="loginPassword" placeholder="Password" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd;">
        <button onclick="handleLogin()" style="width:100%; background:#27ae60; color:white; border:none; padding:10px;">Login</button>
        <p id="loginMsg" style="color:red; font-size:12px;"></p>
    </div>
</div>

<div class="panel container">
    <div class="header-info">
        <input type="text" id="schoolName" placeholder="SCHOOL NAME">
        <input type="text" id="calendarYear" placeholder="2026">
    </div>

    <div class="controls">
        <input type="file" id="csvFile" accept=".csv" hidden onchange="handleUpload(event)">
        <button onclick="document.getElementById('csvFile').click()" style="background:#3498db; color:white;">Upload CSV</button>
        <button onclick="toggleUnavailabilityMode()" id="unavailBtn" class="btn-unavail">Set Unavailability</button>
        <select id="displayMode" onchange="renderMaster()"><option value="both">Subj + Teacher</option><option value="subject">Subject Only</option></select>
        <button onclick="startGeneration()" id="genBtn" class="btn-gen" disabled>Generate</button>
        <button onclick="saveToCloud()" id="saveCloudBtn" style="background:#f39c12; color:white; display:none;">Sync Cloud</button>
        <button onclick="exportToExcel()" class="btn-excel">Excel</button>
        <button onclick="window.print()" style="background:#2c3e50; color:white;">Print</button>
        <button onclick="handleLogout()" style="background:#95a5a6; color:white; margin-left:auto;">Logout</button>
    </div>

    <div class="view-bar" id="viewBar">
        <button onclick="renderMaster()">Master View</button>
        <select id="streamSelect" onchange="renderIndividual('stream')"><option value="">-- Class --</option></select>
        <select id="teacherSelect" onchange="renderIndividual('teacher')"><option value="">-- Teacher --</option></select>
        <button onclick="renderLoadSummary()">Teacher Load</button>
    </div>
    <div id="status" style="text-align:center; font-weight:bold; margin-top:5px;"></div>
</div>

<div id="output" class="container"></div>

<script>
const TIMES = ["08:00-08:40", "08:40-09:20", "09:20-10:00", "10:00-10:40", "TEA BREAK", "11:10-11:50", "11:50-12:30", "12:30-01:10", "01:10-01:50", "01:50-02:30"];
const DAYS = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"];
const PERIODS = ["P1", "P2", "P3", "P4", "BREAK", "P5", "P6", "P7", "P8", "P9"];
const FORMS = ["F1A","F1B","F1C","F1D","F1E","F1F","F1G","F2A","F2B","F2C","F2D","F3A","F3B","F3C","F3D","F4A","F4B","F4C"];

const firebaseConfig = {
  apiKey: "AIzaSyDgbYVR98RE4ZLvkh6vb_dXvkmBRnvFf0w",
  authDomain: "school-timetable-6310b.firebaseapp.com",
  projectId: "school-timetable-6310b",
  storageBucket: "school-timetable-6310b.firebasestorage.app",
  messagingSenderId: "1057156909242",
  appId: "1:1057156909242:web:fdf3cf7a2706f098665a83"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let rawData = [], timetable = [], unavailableSlots = [];
let isUnavailMode = false;

function handleLogin() { auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPassword').value).catch(e => document.getElementById('loginMsg').innerText = e.message); }
function handleLogout() { auth.signOut(); }
auth.onAuthStateChanged(user => { if (user) { document.getElementById('loginOverlay').style.display='none'; loadFromCloud(); } else { document.getElementById('loginOverlay').style.display='flex'; } });

function handleUpload(e) {
    const reader = new FileReader();
    reader.onload = (event) => {
        const lines = event.target.result.split('\n').slice(1).filter(l => l.trim());
        rawData = lines.map(l => { const p = l.split(','); return { subject: p[0].trim(), teacher: p[1].trim(), form: p[3].trim() }; });
        document.getElementById('genBtn').disabled = false;
    };
    reader.readAsText(e.target.files[0]);
}

async function loadFromCloud() {
    const doc = await db.collection("timetable_data").doc("active").get();
    if (doc.exists) {
        const data = doc.data();
        rawData = data.rawData || []; timetable = data.timetable || []; unavailableSlots = data.unavailableSlots || [];
        document.getElementById('schoolName').value = data.schoolName || "";
        document.getElementById('calendarYear').value = data.calendarYear || "";
        document.getElementById('viewBar').style.display = 'block';
        document.getElementById('saveCloudBtn').style.display = 'inline-block';
        document.getElementById('genBtn').disabled = (rawData.length === 0);
        populateFilters(); renderMaster();
    }
}

async function saveToCloud() {
    await db.collection("timetable_data").doc("active").set({ 
        rawData, timetable, unavailableSlots, 
        schoolName: document.getElementById('schoolName').value,
        calendarYear: document.getElementById('calendarYear').value 
    });
    document.getElementById('status').innerText = "âœ… Saved.";
}

function startGeneration() {
    timetable = [];
    const slots = ["P1", "P2", "P3", "P4", "P5", "P6", "P7", "P8", "P9"];
    let groups = {};
    rawData.forEach(item => {
        let key = `${item.form}-${item.subject}`;
        if(!groups[key]) groups[key] = [];
        groups[key].push(item);
    });

    Object.values(groups).forEach(lessons => {
        let remaining = lessons.length;
        while(remaining > 0) {
            let placed = false;
            let isDouble = remaining >= 2;
            for(let a=0; a<500; a++) {
                let d = DAYS[Math.floor(Math.random()*5)];
                if(timetable.some(x => x.day === d && x.form === lessons[0].form && x.subject === lessons[0].subject)) continue;
                let pIdx = Math.floor(Math.random() * slots.length);
                let p1 = slots[pIdx];

                if(d === "WEDNESDAY" && (p1 === "P8" || p1 === "P9")) continue;
                if(d === "FRIDAY" && (p1 === "P7" || p1 === "P8" || p1 === "P9")) continue;

                if(isDouble) {
                    let p2 = slots[pIdx + 1];
                    if(!p2 || p1 === "BREAK" || p2 === "BREAK") continue;
                    if(d === "WEDNESDAY" && (p2 === "P8" || p2 === "P9")) continue;
                    if(!unavailableSlots.includes(`${d}-${p1}-${lessons[0].form}`) && !unavailableSlots.includes(`${d}-${p2}-${lessons[0].form}`) &&
                       !timetable.some(x => x.day===d && x.period===p1 && (x.teacher===lessons[0].teacher || x.form===lessons[0].form)) &&
                       !timetable.some(x => x.day===d && x.period===p2 && (x.teacher===lessons[0].teacher || x.form===lessons[0].form))) {
                        if((p1 === "P4" && p2 === "P5") || (p2 === "P4" && p1 === "P5")) continue;
                        timetable.push({...lessons[0], day: d, period: p1}, {...lessons[0], day: d, period: p2});
                        remaining -= 2; placed = true; break;
                    }
                } else {
                    if(!unavailableSlots.includes(`${d}-${p1}-${lessons[0].form}`) && !timetable.some(x => x.day===d && x.period===p1 && (x.teacher===lessons[0].teacher || x.form===lessons[0].form))) {
                        let forbidden = p1 === "P4" ? "P5" : (p1 === "P5" ? "P4" : null);
                        if(forbidden && timetable.some(x => x.day === d && x.form === lessons[0].form && x.period === forbidden && x.subject === lessons[0].subject)) continue;
                        timetable.push({...lessons[0], day: d, period: p1});
                        remaining -= 1; placed = true; break;
                    }
                }
            }
            if(!placed) remaining--;
        }
    });
    renderMaster();
}

function renderMaster() {
    const mode = document.getElementById('displayMode').value;
    let html = `<h2 style="text-align:center">${document.getElementById('schoolName').value} - ${document.getElementById('calendarYear').value}</h2>`;
    
    DAYS.forEach(day => {
        html += `<div class="day-title">${day}</div><table><tr><th style="width:70px">STREAM</th>`;
        PERIODS.forEach((p, i) => html += `<th>${p}<small>${TIMES[i]}</small></th>`);
        html += `</tr>`;
        
        FORMS.forEach((f, index) => {
            // Add Narrow Separator if the current Form prefix (e.g., F1) differs from the next
            let nextForm = FORMS[index + 1];
            let currentPrefix = f.substring(0, 2);
            let nextPrefix = nextForm ? nextForm.substring(0, 2) : null;

            html += `<tr><td><b>${f}</b></td>`;
            PERIODS.forEach(p => {
                if(p === "BREAK") { html += `<td class="break-cell">BREAK</td>`; }
                else if(day === "WEDNESDAY" && (p === "P8" || p === "P9")) { html += `<td class="religion-cell">RELIGION</td>`; }
                else if(day === "FRIDAY" && (p === "P7" || p === "P8" || p === "P9")) { html += `<td class="friday-strip"></td>`; }
                else {
                    const m = timetable.find(x => x.day === day && x.period === p && x.form === f);
                    const isUn = unavailableSlots.includes(`${day}-${p}-${f}`);
                    let content = isUn ? 'BLOCKED' : (m ? (mode === 'both' ? `<b>${m.subject}</b><br>${m.teacher}` : `<b>${m.subject}</b>`) : '');
                    html += `<td class="${isUn ? 'unavailable-block' : ''}" onclick="markUnavailable('${day}','${p}','${f}')">${content}</td>`;
                }
            });
            html += `</tr>`;
            
            // Render the separator row if the Form level changes
            if (nextPrefix && currentPrefix !== nextPrefix) {
                html += `<tr><td colspan="${PERIODS.length + 1}" class="form-separator"></td></tr>`;
            }
        });
        html += `</table>`;
    });
    document.getElementById('output').innerHTML = html;
}

function toggleUnavailabilityMode() { isUnavailMode = !isUnavailMode; document.getElementById('unavailBtn').innerText = isUnavailMode ? "EXIT EDIT" : "Set Unavailability"; renderMaster(); }
function markUnavailable(d, p, f) { if(isUnavailMode) { const key = `${d}-${p}-${f}`; const idx = unavailableSlots.indexOf(key); if(idx > -1) unavailableSlots.splice(idx, 1); else unavailableSlots.push(key); renderMaster(); } }
function populateFilters() {
    const teachers = [...new Set(rawData.map(x => x.teacher))].sort();
    document.getElementById('teacherSelect').innerHTML = '<option value="">-- Teacher --</option>' + teachers.map(t => `<option value="${t}">${t}</option>`).join('');
    document.getElementById('streamSelect').innerHTML = '<option value="">-- Class --</option>' + FORMS.map(f => `<option value="${f}">${f}</option>`).join('');
}

function exportToExcel() {
    const wb = XLSX.utils.book_new();
    DAYS.forEach(day => {
        const rows = [["STREAM", ...PERIODS]];
        FORMS.forEach(f => {
            const row = [f];
            PERIODS.forEach(p => {
                if(p === "BREAK") row.push("TEA");
                else if(day === "WEDNESDAY" && (p === "P8" || p === "P9")) row.push("RELIGION");
                else if(day === "FRIDAY" && (p === "P7" || p === "P8" || p === "P9")) row.push("---");
                else {
                    const m = timetable.find(x => x.day === day && x.period === p && x.form === f);
                    row.push(m ? `${m.subject} (${m.teacher})` : "");
                }
            });
            rows.push(row);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), day);
    });
    XLSX.writeFile(wb, "School_Timetable_2026.xlsx");
}

function renderIndividual(type) {
    const val = type === 'stream' ? document.getElementById('streamSelect').value : document.getElementById('teacherSelect').value;
    if(!val) return;
    let html = `<h2>${val} Schedule</h2><table><tr><th>DAY</th>`;
    PERIODS.forEach((p, i) => html += `<th>${p}<small>${TIMES[i]}</small></th>`);
    html += `</tr>`;
    DAYS.forEach(day => {
        html += `<tr><td><b>${day}</b></td>`;
        PERIODS.forEach(p => {
            if(p === "BREAK") html += `<td class="break-cell">TEA</td>`;
            else if(day === "WEDNESDAY" && (p === "P8" || p === "P9") && type === 'stream') html += `<td class="religion-cell">RELIGION</td>`;
            else if(day === "FRIDAY" && (p === "P7" || p === "P8" || p === "P9")) html += `<td class="friday-strip"></td>`;
            else {
                const m = timetable.find(x => x.day === day && x.period === p && (type === 'stream' ? x.form === val : x.teacher === val));
                html += `<td>${m ? `<b>${m.subject}</b><br>${type==='stream'?m.teacher:'Form: '+m.form}` : ''}</td>`;
            }
        });
        html += `</tr>`;
    });
    document.getElementById('output').innerHTML = html + `</table>`;
}

function renderLoadSummary() {
    const load = {};
    rawData.forEach(r => load[r.teacher] = (load[r.teacher] || 0) + 1);
    let html = `<h2 style="text-align:center">TEACHER LOAD</h2><table style="max-width:400px; margin:auto"><tr><th>Teacher</th><th>Lessons</th></tr>`;
    Object.keys(load).sort().forEach(t => html += `<tr><td>${t}</td><td><b>${load[t]}</b></td></tr>`);
    document.getElementById('output').innerHTML = html + `</table>`;
}
</script>
</body>
</html>
