<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Timetable - Compact Day Layout</title>
<style>
    body {
        font-family: Arial, Helvetica, sans-serif;
        background: #f8f9fa;
        margin: 0;
        padding: 12px;
        color: #222;
    }
    .container { max-width: 1380px; margin: 0 auto; }

    .panel {
        background: white;
        padding: 14px;
        border-radius: 8px;
        box-shadow: 0 1px 6px rgba(0,0,0,0.08);
        margin-bottom: 18px;
    }

    button, input, select {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 5px;
        border: 1px solid #ccc;
        margin: 3px;
    }

    .master-timetable {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
        background: white;
        margin: 10px 0 20px;
        line-height: 1.15;
    }

    th, td {
        border: 1px solid #666;
        padding: 3px 4px;
        text-align: center;
        height: 26px;
    }

    th {
        background: #2c3e50;
        color: white;
        font-weight: normal;
        font-size: 9.5px;
    }

    .break-cell {
        background: #f1f3f5;
        color: #444;
        font-weight: bold;
        font-size: 9px;
        width: 60px;
    }

    .fixed {
        background: #e3f2fd;
        color: #0d47a1;
        font-weight: bold;
        font-size: 9px;
    }

    .group-separator td {
        background: #ffcc00;
        height: 5px;
        padding: 0;
        border: none;
    }

    .day-title {
        background: #34495e;
        color: white;
        padding: 8px;
        font-size: 1.2em;
        margin: 18px 0 6px;
        text-align: center;
        border-radius: 5px;
    }

    .form-col {
        font-weight: bold;
        width: 52px;
        font-size: 10.5px;
    }

    .time-small {
        font-size: 8px;
        color: #ddd;
        display: block;
        margin-top: 1px;
    }

    .lesson-subject { font-size: 10px; }
    .lesson-teacher {
        font-size: 8.5px;
        color: #444;
        display: block;
        margin-top: 1px;
    }

    @media print {
        .panel { display: none; }
        body { padding: 0; margin: 0; }
        .master-timetable { page-break-inside: avoid; }
        .day-title { page-break-before: always; margin-top: 0; }
    }
</style>
</head>
<body>

<div class="panel container">
    <h2 style="margin:0 0 12px 0; text-align:center">School Timetable - Compact View</h2>

    <div style="text-align:center; margin:12px 0;">
        <input id="school" placeholder="School Name" style="width:220px">
        <input id="year" placeholder="Year" style="width:100px">
        <select id="display">
            <option value="subject">Subject only</option>
            <option value="full" selected>Subject + Teacher</option>
        </select>
    </div>

    <div style="text-align:center;">
        <button onclick="document.getElementById('csv').click()" class="blue">Upload CSV</button>
        <input type="file" id="csv" accept=".csv" hidden onchange="loadCSV(event)">
        <button onclick="generate()" class="green" id="genBtn" disabled>Generate</button>
        <button onclick="window.print()" class="gray">Print</button>
    </div>

    <p id="status" style="margin-top:12px; font-weight:bold; text-align:center">
        Upload lesson demand CSV to begin...
    </p>
</div>

<div class="container" id="output"></div>

<script>
const DAYS = ["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY"];
const PERIODS = [
    {c:"P1",t:"8:00-8:40"},{c:"P2",t:"8:40-9:20"},{c:"P3",t:"9:20-10:00"},
    {c:"P4",t:"10:00-10:40"},{c:"BREAK",t:"10:40-11:10"},
    {c:"P5",t:"11:10-11:50"},{c:"P6",t:"11:50-12:30"},{c:"P7",t:"12:30-13:10"},
    {c:"P8",t:"13:10-13:50"},{c:"P9",t:"13:50-14:30"}
];

let lessons = [];
let timetable = [];

function isFixed(day, p) {
    if (day === "WEDNESDAY" && ["P8","P9"].includes(p)) return "RELIGION";
    if (day === "FRIDAY" && ["P7","P8","P9"].includes(p)) return "MOSQUE";
    return null;
}

function loadCSV(e) {
    const file = e.target.files[0];
    if (!file) return;
    const r = new FileReader();
    r.onload = () => {
        lessons = r.result.split("\n").slice(1)
            .map(l=>l.trim())
            .filter(l=>l)
            .map(l=>{
                const [sub, tea,, frm] = l.split(",").map(x=>x.trim());
                return {subject:sub, teacher:tea||null, form:frm};
            });
        document.getElementById("genBtn").disabled = false;
        document.getElementById("status").innerText = 
            `Loaded ${lessons.length} periods • ${new Set(lessons.map(l=>l.form)).size} classes`;
    };
    r.readAsText(file);
}

function generate() {
    if (!lessons.length) return alert("Upload CSV first");
    
    timetable = [];
    const used = {}; // form → day → period

    lessons.forEach(l=>{
        if(!used[l.form]) used[l.form]={};
        DAYS.forEach(d=>{if(!used[l.form][d]) used[l.form][d]={}});
    });

    // Simple greedy double placement
    const groups = {};
    lessons.forEach(l=>{
        const k = l.form+"|"+l.subject;
        if(!groups[k]) groups[k]=[];
        groups[k].push(l);
    });

    Object.values(groups).forEach(g=>{
        const f = g[0].form;
        const s = g[0].subject;
        const t = g[0].teacher;
        let rem = g.length;

        while(rem>=2){
            let placed=false;
            for(const d of DAYS){
                for(const [p1,p2] of [['P1','P2'],['P2','P3'],['P3','P4'],['P5','P6'],['P6','P7'],['P7','P8'],['P8','P9']]){
                    if(!used[f][d][p1] && !used[f][d][p2] && !isFixed(d,p1) && !isFixed(d,p2)){
                        timetable.push({form:f,subject:s,teacher:t,day:d,period:p1});
                        timetable.push({form:f,subject:s,teacher:t,day:d,period:p2});
                        used[f][d][p1]=used[f][d][p2]=true;
                        rem-=2;
                        placed=true;
                        break;
                    }
                }
                if(placed) break;
            }
            if(!placed) break;
        }

        while(rem>0){
            let placed=false;
            for(const d of DAYS){
                for(const p of PERIODS.map(pp=>pp.c).filter(c=>c!=="BREAK")){
                    if(!used[f][d][p] && !isFixed(d,p)){
                        timetable.push({form:f,subject:s,teacher:t,day:d,period:p});
                        used[f][d][p]=true;
                        rem--;
                        placed=true;
                        break;
                    }
                }
                if(placed) break;
            }
            if(!placed) break;
        }
    });

    renderCompact();
    document.getElementById("status").innerText = 
        `Done • ${timetable.length}/${lessons.length} periods placed`;
}

function renderCompact() {
    const out = document.getElementById("output");
    out.innerHTML = "";

    const school = document.getElementById("school").value.trim() || "School";
    const year   = document.getElementById("year").value.trim()   || "2026";
    const mode   = document.getElementById("display").value;

    out.innerHTML += `<h2 style="text-align:center;margin-bottom:8px">${school} – ${year}</h2>`;

    const forms = [...new Set(lessons.map(l=>l.form))].sort();

    DAYS.forEach(day => {
        out.innerHTML += `<div class="day-title">${day}</div>`;

        let html = `
        <table class="master-timetable">
        <thead>
            <tr>
                <th rowspan="2" class="form-col">FORM</th>
                <th colspan="4">MORNING</th>
                <th rowspan="2" class="break-cell">BREAK</th>
                <th colspan="5">AFTERNOON</th>
            </tr>
            <tr>`;

        PERIODS.forEach(p=>{
            if(p.c==="BREAK") return;
            html += `<th>${p.c}<span class="time-small">${p.t}</span></th>`;
        });

        html += `</tr></thead><tbody>`;

        let prevLevel = "";
        forms.forEach(form => {
            const level = form.slice(0,2);
            if(level !== prevLevel){
                if(prevLevel) html += `<tr class="group-separator"><td colspan="11"></td></tr>`;
                prevLevel = level;
            }

            html += `<tr><td class="form-col"><b>${form}</b></td>`;

            PERIODS.forEach(per => {
                if(per.c === "BREAK"){
                    html += `<td class="break-cell">BREAK</td>`;
                    return;
                }

                const fixed = isFixed(day, per.c);
                if(fixed){
                    html += `<td class="fixed">${fixed}</td>`;
                    return;
                }

                const les = timetable.find(l => 
                    l.form === form && l.day === day && l.period === per.c
                );

                if(les){
                    if(mode === "full" && les.teacher){
                        html += `<td><span class="lesson-subject">${les.subject}</span><span class="lesson-teacher">${les.teacher}</span></td>`;
                    } else {
                        html += `<td><span class="lesson-subject">${les.subject}</span></td>`;
                    }
                } else {
                    html += `<td></td>`;
                }
            });

            html += `</tr>`;
        });

        html += `</tbody></table>`;
        out.innerHTML += html;
    });
}
</script>
</body>
</html>
