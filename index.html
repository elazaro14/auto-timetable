<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Official School Timetable Generator</title>

<style>
body{font-family:Segoe UI,Arial;background:#f4f6f8;padding:20px}
.no-print{background:#fff;padding:20px;border-radius:8px;box-shadow:0 3px 12px rgba(0,0,0,.15);margin-bottom:20px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
input,select,button{padding:8px;border-radius:4px;border:1px solid #ccc;font-weight:bold}
button{background:#007bff;color:white;border:none;cursor:pointer}
button.green{background:#28a745}
button.gray{background:#6c757d}
table{border-collapse:collapse;width:100%;table-layout:fixed;background:#fff}
th,td{border:1px solid #333;padding:4px;font-size:11px;text-align:center;height:48px}
th{background:#2c3e50;color:#fff}
.day-title{background:#34495e;color:#fff;padding:8px;font-size:18px;text-align:center;margin-top:20px}
.break{background:#eee;font-weight:bold}
.fixed{background:#d1ecf1;font-weight:bold;color:#0c5460}
small{font-weight:normal}
@media print{.no-print{display:none}body{padding:0;background:white}}
</style>
</head>

<body>

<div class="no-print">
<h2>ðŸ‡¹ðŸ‡¿ Official School Timetable System</h2>

<div class="controls">
<input id="schoolName" placeholder="School Name">
<input id="year" placeholder="Academic Year (e.g. 2026)">
<input type="file" accept=".csv" onchange="loadCSV(event)">
<button id="genBtn" class="green" disabled onclick="generate()">Generate</button>
<button class="gray" onclick="window.print()">Print</button>
</div>

<div class="controls" id="views" style="display:none">
<button onclick="renderMaster()">Master View</button>
<select id="streamSel" onchange="renderIndividual('stream')">
<option value="">-- Stream --</option>
</select>
<select id="teacherSel" onchange="renderIndividual('teacher')">
<option value="">-- Teacher --</option>
</select>
</div>

<div id="status"><b>Upload CSV to begin</b></div>
</div>

<div id="output"></div>

<script>
/* ------------------ CONSTANTS ------------------ */
const days=["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY"];
const periods=[
 {p:"P1",t:"08:00â€“08:40"},
 {p:"P2",t:"08:40â€“09:20"},
 {p:"P3",t:"09:20â€“10:00"},
 {p:"P4",t:"10:00â€“10:40"},
 {p:"BREAK",t:"10:40â€“11:10"},
 {p:"P5",t:"11:10â€“11:50"},
 {p:"P6",t:"11:50â€“12:30"},
 {p:"P7",t:"12:30â€“13:10"},
 {p:"P8",t:"13:10â€“13:50"},
 {p:"P9",t:"13:50â€“14:30"}
];
const forms=["F1A","F1B","F1C","F1D","F1E","F1F","F1G",
             "F2A","F2B","F2C","F2D",
             "F3A","F3B","F3C","F3D",
             "F4A","F4B","F4C"];
const doubleSlots=[["P1","P2"],["P2","P3"],["P3","P4"],["P5","P6"],["P6","P7"],["P7","P8"],["P8","P9"]];

let lessons=[], timetable=[];

/* ------------------ FIXED BLOCKS ------------------ */
function fixed(day,p){
 if(day==="WEDNESDAY"&&(p==="P8"||p==="P9"))return"RELIGION";
 if(day==="FRIDAY"&&(p==="P7"||p==="P8"||p==="P9"))return"MOSQUE";
 return null;
}

/* ------------------ LOAD CSV ------------------ */
function loadCSV(e){
 const r=new FileReader();
 r.onload=()=>{
  const rows=r.result.split("\n").slice(1).filter(x=>x.trim());
  const map={};
  rows.forEach(l=>{
   let [sub,teach,room,form]=l.split(",").map(x=>x.trim());
   let k=`${form}-${sub}-${teach}`;
   map[k]=(map[k]||0)+1;
  });
  lessons=[];
  Object.entries(map).forEach(([k,c])=>{
   let [f,s,t]=k.split("-");
   for(let i=0;i<c;i++)lessons.push({form:f,subject:s,teacher:t});
  });
  document.getElementById("genBtn").disabled=false;
  document.getElementById("status").innerText=`Loaded ${lessons.length} lessons`;
 };
 r.readAsText(e.target.files[0]);
}

/* ------------------ GENERATOR (STRICT RULE) ------------------ */
function generate(){
 const grid={},usedDay={};
 timetable=[];
 forms.forEach(f=>{
  grid[f]={};usedDay[f]={};
  days.forEach(d=>{
   grid[f][d]={};usedDay[f][d]={};
   periods.forEach(p=>{
    if(p.p!=="BREAK"&&!fixed(d,p.p))grid[f][d][p.p]=null;
   });
  });
 });

 const groups={};
 lessons.forEach(l=>{
  let k=`${l.form}-${l.subject}`;
  (groups[k]=groups[k]||[]).push(l);
 });

 Object.entries(groups).forEach(([k,list])=>{
  let [form,subject]=k.split("-");
  let teacher=list[0].teacher;
  let remain=list.length;

  /* DOUBLES FIRST */
  while(remain>=2){
   let placed=false;
   days.forEach(d=>{
    if(placed||usedDay[form][d][subject])return;
    doubleSlots.forEach(([a,b])=>{
     if(!placed&&grid[form][d][a]===null&&grid[form][d][b]===null){
      timetable.push({form,subject,teacher,day:d,period:a});
      timetable.push({form,subject,teacher,day:d,period:b});
      grid[form][d][a]=grid[form][d][b]=true;
      usedDay[form][d][subject]=true;
      remain-=2;placed=true;
     }
    });
   });
   if(!placed)break;
  }

  /* SINGLE ONLY IF DAY EMPTY */
  while(remain>0){
   let done=false;
   days.forEach(d=>{
    if(done||usedDay[form][d][subject])return;
    Object.keys(grid[form][d]).forEach(p=>{
     if(!done&&grid[form][d][p]===null){
      timetable.push({form,subject,teacher,day:d,period:p});
      grid[form][d][p]=true;
      usedDay[form][d][subject]=true;
      remain--;done=true;
     }
    });
   });
   if(!done)break;
  }
 });

 buildSelectors();
 renderMaster();
 document.getElementById("views").style.display="flex";
 document.getElementById("status").innerText="Timetable generated âœ”";
}

/* ------------------ SELECTORS ------------------ */
function buildSelectors(){
 document.getElementById("streamSel").innerHTML=
  '<option value="">-- Stream --</option>'+
  forms.map(f=>`<option>${f}</option>`).join("");
 document.getElementById("teacherSel").innerHTML=
  '<option value="">-- Teacher --</option>'+
  [...new Set(timetable.map(x=>x.teacher))].map(t=>`<option>${t}</option>`).join("");
}

/* ------------------ MASTER VIEW ------------------ */
function renderMaster(){
 let s=document.getElementById("schoolName").value||"SCHOOL";
 let y=document.getElementById("year").value||"";
 let h=`<center><h1>${s}</h1><h3>${y}</h3></center>`;
 days.forEach(d=>{
  h+=`<div class="day-title">${d}</div><table><tr><th>STREAM</th>`+
     periods.map(p=>`<th>${p.p}<br><small>${p.t}</small></th>`).join("")+"</tr>";
  forms.forEach(f=>{
   h+=`<tr><td><b>${f}</b></td>`;
   periods.forEach(p=>{
    if(p.p==="BREAK")h+=`<td class="break">BREAK</td>`;
    else if(fixed(d,p.p))h+=`<td class="fixed">${fixed(d,p.p)}</td>`;
    else{
     let l=timetable.find(x=>x.day===d&&x.form===f&&x.period===p.p);
     h+=`<td>${l?l.subject:""}</td>`;
    }
   });
   h+="</tr>";
  });
  h+="</table>";
 });
 document.getElementById("output").innerHTML=h;
}

/* ------------------ INDIVIDUAL VIEW ------------------ */
function renderIndividual(type){
 let val=type==="stream"?streamSel.value:teacherSel.value;
 if(!val)return;
 let h=`<center><h2>${type.toUpperCase()} TIMETABLE: ${val}</h2></center>`;
 h+=`<table><tr><th>DAY</th>`+
    periods.map(p=>`<th>${p.p}<br><small>${p.t}</small></th>`).join("")+"</tr>";
 days.forEach(d=>{
  h+=`<tr><td><b>${d}</b></td>`;
  periods.forEach(p=>{
   if(p.p==="BREAK")h+=`<td class="break">BREAK</td>`;
   else if(fixed(d,p.p))h+=`<td class="fixed">${fixed(d,p.p)}</td>`;
   else{
    let l=timetable.find(x=>x.day===d&&(type==="stream"?x.form===val:x.teacher===val)&&x.period===p.p);
    h+=`<td>${l?l.subject+"<br>"+(type==="stream"?l.teacher:l.form):""}</td>`;
   }
  });
  h+="</tr>";
 });
 h+="</table>";
 document.getElementById("output").innerHTML=h;
}
</script>

</body>
</html>
