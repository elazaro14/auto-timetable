<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>School Timetable Generator</title>
<style>
 body{font-family:Arial;background:#f4f6f8}
 table{border-collapse:collapse;width:100%;margin-top:10px}
 th,td{border:1px solid #444;padding:6px;text-align:center;font-size:13px}
 th{background:#2c3e50;color:white}
 select,input,button{padding:6px;margin:4px}
 #views{display:none;gap:10px;flex-wrap:wrap}
 .hdr{background:#34495e;color:#fff;font-weight:bold}
</style>
</head>

<body>

<h2 id="schoolTitle">School Timetable</h2>

<input id="schoolName" placeholder="School Name">
<input id="year" placeholder="Academic Year">
<button onclick="applyHeader()">Apply</button>

<hr>

<input type="file" accept=".csv" onchange="loadCSV(event)">
<button id="genBtn" onclick="startEvolution()" disabled>Generate</button>

<select id="displayMode">
 <option value="subject">Subject only</option>
 <option value="both">Subject & Teacher</option>
</select>

<div id="status"></div>

<div id="views">
 <button onclick="renderMaster()">Master Timetable</button>
</div>

<div id="output"></div>

<script>
/* ---------------- BASIC ---------------- */
const days=["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY"];

const periods=[
 {p:"P1",t:"08:00–08:40"},
 {p:"P2",t:"08:40–09:20"},
 {p:"P3",t:"09:20–10:00"},
 {p:"P4",t:"10:00–10:40"},
 {p:"BREAK",t:"10:40–11:10"},
 {p:"P5",t:"11:10–11:50"},
 {p:"P6",t:"11:50–12:30"},
 {p:"P7",t:"12:30–13:10"},
 {p:"P8",t:"13:10–13:50"},
 {p:"P9",t:"13:50–14:30"}
];

const validPeriods=periods.filter(x=>x.p!=="BREAK").map(x=>x.p);

let data=[],finalTT=[];

/* ---------------- FIXED PERIODS ---------------- */
function isFixed(day,p){
 if(day==="WEDNESDAY"&&(p==="P8"||p==="P9"))return true;
 if(day==="FRIDAY"&&(p==="P7"||p==="P8"||p==="P9"))return true;
 return false;
}

function randPeriod(day){
 let p;
 do{
  p=validPeriods[Math.floor(Math.random()*validPeriods.length)];
 }while(isFixed(day,p));
 return p;
}

/* ---------------- UI ---------------- */
function status(t){document.getElementById("status").innerText=t;}

function applyHeader(){
 document.getElementById("schoolTitle").innerText=
  schoolName.value+" — "+year.value;
}

/* ---------------- CSV ---------------- */
function loadCSV(e){
 const r=new FileReader();
 r.onload=()=>{
  data=r.result.split("\n").slice(1)
   .filter(x=>x.trim())
   .map(l=>{
    let p=l.split(",");
    return{
     subject:p[0].trim(),
     teacher:p[1].trim(),
     form:p[3].trim()
    };
   });
  genBtn.disabled=false;
  status("CSV loaded ✔");
 };
 r.readAsText(e.target.files[0]);
}

/* ---------------- FITNESS (DOUBLE FIRST) ---------------- */
function fitness(tt){
 let score = 100000;
 let pen = 0;

 /* ---------- SLOT CLASH (HARD) ---------- */
 const slot = {};
 tt.forEach(x=>{
  let k = `${x.day}-${x.period}`;
  slot[k] = slot[k] || [];
  slot[k].push(x);
 });
 Object.values(slot).forEach(s=>{
  if(s.length > 1) pen += 50000;
 });

 /* ---------- SUBJECT PER STREAM PER DAY ---------- */
 const group = {};
 tt.forEach(x=>{
  let k = `${x.form}-${x.day}-${x.subject}`;
  group[k] = group[k] || [];
  group[k].push(+x.period.slice(1));
 });

 Object.values(group).forEach(p=>{
  p.sort((a,b)=>a-b);

  /* ❌ more than 2 periods */
  if(p.length > 2){
   pen += 50000;
   return;
  }

  /* ❌ split double */
  if(p.length === 2 && p[1] - p[0] !== 1){
   pen += 50000;
   return;
  }

  /* ✅ perfect double */
  if(p.length === 2 && p[1] - p[0] === 1){
   score += 3000;
   return;
  }

  /* ✅ single period */
  if(p.length === 1){
   score += 500;
  }
 });

 return score / (1 + pen);
}

/* ---------------- GENERATION ---------------- */
function startEvolution(){
 let pop=[...Array(60)].map(()=>data.map(d=>{
  let day=days[Math.floor(Math.random()*5)];
  return{...d,day,period:randPeriod(day)};
 }));

 let gen=0;
 const timer=setInterval(()=>{
  gen++;
  pop.sort((a,b)=>fitness(b)-fitness(a));
  status("Generating… "+gen);

  if(gen>2000){
   clearInterval(timer);
   finalTT=pop[0];
   renderMaster();
   views.style.display="flex";
   status("Completed ✔ Doubles prioritized");
  }

  let next=pop.slice(0,15);
  while(next.length<60){
   let c=JSON.parse(JSON.stringify(next[Math.floor(Math.random()*15)]));
   let x=c[Math.floor(Math.random()*c.length)];
   x.day=days[Math.floor(Math.random()*5)];
   x.period=randPeriod(x.day);
   next.push(c);
  }
  pop=next;
 },10);
}

/* ---------------- RENDER MASTER ---------------- */
function renderMaster(){
 let mode=document.getElementById("displayMode").value;
 let forms=[...new Set(finalTT.map(x=>x.form))];
 let html="";

 forms.forEach(f=>{
  html+=`<h3>${f}</h3><table><tr><th>Day</th>`;
  periods.forEach(p=>{
   html+=`<th>${p.p}<br>${p.t}</th>`;
  });
  html+="</tr>";

  days.forEach(d=>{
   html+=`<tr><th>${d}</th>`;
   periods.forEach(p=>{
    if(p.p==="BREAK"){html+="<td>BREAK</td>";return;}
    let cell=finalTT.find(x=>x.form===f && x.day===d && x.period===p.p);
    if(!cell)html+="<td></td>";
    else html+="<td>"+(mode==="both"
     ?cell.subject+"<br>"+cell.teacher
     :cell.subject)+"</td>";
   });
   html+="</tr>";
  });
  html+="</table><br>";
 });

 output.innerHTML=html;
}
</script>
</body>
</html>

