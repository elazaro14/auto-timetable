<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Timetable - Strict 1 Block per Subject per Day</title>
<style>
    body {
        font-family: Arial, Helvetica, sans-serif;
        background: #f8f9fa;
        margin: 0;
        padding: 12px;
        color: #222;
    }
    .container { max-width: 1380px; margin: 0 auto; }
    .panel {
        background: white;
        padding: 14px;
        border-radius: 8px;
        box-shadow: 0 1px 6px rgba(0,0,0,0.08);
        margin-bottom: 18px;
    }
    button, input, select {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 5px;
        border: 1px solid #ccc;
        margin: 3px;
    }
    .master-timetable, .individual-timetable {
        width: 100%; border-collapse: collapse; font-size: 10px;
        background: white; margin: 10px 0 20px; line-height: 1.15;
    }
    th, td { border: 1px solid #666; padding: 3px 4px; text-align: center; height: 26px; }
    th { background: #2c3e50; color: white; font-weight: normal; font-size: 9.5px; }
    .break-cell { background: #f1f3f5; color: #444; font-weight: bold; font-size: 9px; width: 60px; }
    .fixed { background: #e3f2fd; color: #0d47a1; font-weight: bold; font-size: 9px; }
    .group-separator td { background: #ffcc00; height: 5px; padding: 0; border: none; }
    .day-title { background: #34495e; color: white; padding: 8px; font-size: 1.2em; margin: 18px 0 6px; text-align: center; border-radius: 5px; }
    .form-col { font-weight: bold; width: 52px; font-size: 10.5px; }
    .time-small { font-size: 8px; color: #ddd; display: block; margin-top: 1px; }
    .lesson-subject { font-size: 10px; }
    .lesson-teacher { font-size: 8.5px; color: #444; display: block; margin-top: 1px; }
    .view-controls { margin: 15px 0; padding: 10px; background: #f1f3f5; border-radius: 6px; display: none; }
    @media print {
        .panel, .view-controls { display: none !important; }
        body { padding: 0; margin: 0; }
        .master-timetable, .individual-timetable { page-break-inside: avoid; }
        .day-title { page-break-before: always; margin-top: 0; }
    }
</style>
</head>
<body>

<div class="panel container">
    <h2 style="margin:0 0 12px 0; text-align:center">School Timetable Generator</h2>
    
    <div style="text-align:center; margin:12px 0;">
        <input id="school" placeholder="School Name" style="width:220px">
        <input id="year" placeholder="Year" style="width:100px">
        <select id="display">
            <option value="subject">Subject only</option>
            <option value="full" selected>Subject + Teacher</option>
        </select>
    </div>

    <div style="text-align:center;">
        <button onclick="document.getElementById('csv').click()" class="blue">Upload CSV</button>
        <input type="file" id="csv" accept=".csv" hidden onchange="loadCSV(event)">
        <button onclick="generate()" class="green" id="genBtn" disabled>Generate</button>
        <button onclick="window.print()" class="gray">Print Current View</button>
    </div>

    <div class="view-controls" id="viewControls">
        <strong>View:</strong>
        <button onclick="renderMaster()">Full Master View</button>
        <select id="streamSelect" onchange="renderStream()">
            <option value="">-- Select Stream --</option>
        </select>
        <select id="teacherSelect" onchange="renderTeacher()">
            <option value="">-- Select Teacher --</option>
        </select>
    </div>

    <p id="status" style="margin-top:12px; font-weight:bold; text-align:center">
        Upload CSV → Strict rule: max **one block** (single OR double) per subject per day per class
    </p>
</div>

<div class="container" id="output"></div>

<script>
const DAYS = ["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY"];
const PERIODS = [
    {c:"P1",t:"8:00-8:40"},{c:"P2",t:"8:40-9:20"},{c:"P3",t:"9:20-10:00"},
    {c:"P4",t:"10:00-10:40"},{c:"BREAK",t:"10:40-11:10"},
    {c:"P5",t:"11:10-11:50"},{c:"P6",t:"11:50-12:30"},{c:"P7",t:"12:30-13:10"},
    {c:"P8",t:"13:10-13:50"},{c:"P9",t:"13:50-14:30"}
];

const DOUBLE_PAIRS = [['P1','P2'],['P2','P3'],['P3','P4'],['P5','P6'],['P6','P7'],['P7','P8'],['P8','P9']];

let lessonsDemand = [];
let timetable = [];
let allForms = [];
let allTeachers = new Set();

function isFixed(day, p) {
    if (day === "WEDNESDAY" && ["P8","P9"].includes(p)) return "RELIGION";
    if (day === "FRIDAY"    && ["P7","P8","P9"].includes(p)) return "MOSQUE";
    return null;
}

function loadCSV(e) {
    const file = e.target.files[0];
    if (!file) return;

    const r = new FileReader();
    r.onload = () => {
        lessonsDemand = r.result.split("\n").slice(1)
            .map(l=>l.trim())
            .filter(l=>l)
            .map(l=>{
                const [sub, tea,, frm] = l.split(",").map(x=>x.trim());
                if (tea) allTeachers.add(tea);
                return {subject:sub, teacher:tea||null, form:frm};
            })
            .filter(l => l.subject && l.form);

        allForms = [...new Set(lessonsDemand.map(l=>l.form))].sort();

        document.getElementById("genBtn").disabled = false;
        document.getElementById("status").innerText = 
            `Loaded ${lessonsDemand.length} periods • ${allForms.length} classes • ${allTeachers.size} teachers`;
    };
    r.readAsText(file);
}

// ── Main generation with strict 1-block-per-subject-per-day rule ─────
function generate() {
    if (!lessonsDemand.length) return alert("Please upload CSV first!");

    timetable = [];

    const classUsed     = {}; // form   → day → period
    const teacherUsed   = {}; // teacher→ day → period
    const subjectBlock  = {}; // form → subject → day → "single" | "double"

    // Initialize
    lessonsDemand.forEach(l => {
        if (!classUsed[l.form]) classUsed[l.form] = {};
        DAYS.forEach(d => { if (!classUsed[l.form][d]) classUsed[l.form][d] = {}; });

        if (!subjectBlock[l.form]) subjectBlock[l.form] = {};
        if (!subjectBlock[l.form][l.subject]) subjectBlock[l.form][l.subject] = {};
        DAYS.forEach(d => { subjectBlock[l.form][l.subject][d] = null; });
    });

    // Group by form + subject
    const groups = {};
    lessonsDemand.forEach(l => {
        const key = `${l.form}|${l.subject}`;
        groups[key] = groups[key] || [];
        groups[key].push(l);
    });

    Object.values(groups).forEach(group => {
        const form = group[0].form;
        const subject = group[0].subject;
        const teacher = group[0].teacher;
        let remaining = group.length;

        // Phase 1: Try to place doubles first (preferred)
        while (remaining >= 2) {
            let placed = false;
            for (const day of DAYS) {
                // Already has this subject today → skip
                if (subjectBlock[form][subject][day]) continue;

                for (const [p1, p2] of DOUBLE_PAIRS) {
                    const s1 = !classUsed[form][day][p1] && !isFixed(day, p1);
                    const s2 = !classUsed[form][day][p2] && !isFixed(day, p2);

                    let tFree = true;
                    if (teacher) {
                        teacherUsed[teacher] = teacherUsed[teacher] || {};
                        teacherUsed[teacher][day] = teacherUsed[teacher][day] || {};
                        tFree = !teacherUsed[teacher][day][p1] && !teacherUsed[teacher][day][p2];
                    }

                    if (s1 && s2 && tFree) {
                        timetable.push({form, subject, teacher, day, period: p1});
                        timetable.push({form, subject, teacher, day, period:
