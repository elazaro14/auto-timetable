<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timetable 2026 - Master Pro (Final Build)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --row-height: 38px; --font-size: 11px; --cell-padding: 4px; --primary: #2c3e50; }
        .compact-mode { --row-height: 28px !important; --font-size: 10px !important; --cell-padding: 2px !important; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 5px; }
        .panel { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 10px; border-top: 4px solid var(--primary); }
        .print-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: white; padding: 5px; }
        .logo-container { width: 50px; height: 50px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .logo-container img { max-width: 100%; max-height: 100%; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        .input-group label { font-size: 10px; font-weight: bold; color: #666; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; border: 2px solid #000; margin-top: 10px; }
        th, td { border: 1px solid #000; text-align: center; padding: var(--cell-padding); font-size: var(--font-size); height: var(--row-height); line-height: 1.1; }
        th { background: #f8f9fa; }
        .day-title { background: var(--primary); color: white; padding: 8px; font-weight: bold; text-align: center; margin-top: 15px; border: 2px solid #000; border-bottom: none; }
        .break-cell, .spec-merged { background: #eeeeee !important; font-weight: bold; width: 25px !important; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); display: inline-block; white-space: nowrap; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; flex-wrap: wrap; }
        button { padding: 8px 16px; border-radius: 4px; border: 1px solid #ccc; background: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #f0f0f0; }
        .btn-gen { background: #27ae60 !important; color: white; border: none; }
        @media print { .no-print { display: none !important; } .day-section { page-break-after: always; } }
    </style>
</head>
<body class="compact-mode">

<div class="panel no-print">
    <div class="print-header">
        <div class="logo-container" id="logoBox" onclick="document.getElementById('logoIn').click()">LOGO</div>
        <input type="file" id="logoIn" hidden onchange="loadLogo(event)">
        <input type="text" id="schName" placeholder="SCHOOL NAME" style="font-size: 18px; text-align: center; flex-grow: 1; border: none; border-bottom: 2px solid #eee;">
        <div id="status" style="color: red; font-weight: bold; font-size: 10px;">READY</div>
    </div>
    <div class="config-grid">
        <div class="input-group"><label>Start</label><input type="time" id="tTime" value="08:00"></div>
        <div class="input-group"><label>Duration</label><input type="number" id="tDur" value="40"></div>
        <div class="input-group"><label>Periods</label><input type="number" id="tCount" value="9"></div>
    </div>
    <div class="controls">
        <input type="file" id="csvIn" hidden onchange="readCSV(event)">
        <button onclick="document.getElementById('csvIn').click()">1. UPLOAD CSV</button>
        <button class="btn-gen" onclick="runGenerator()">2. GENERATE / RESCHEDULE</button>
        <button onclick="drawLoad()">CHECK LOAD</button>
        <button onclick="window.print()">PRINT</button>
    </div>
</div>

<div id="viewBar" class="no-print" style="text-align:center; display:none; padding:10px; background:#fff; border-bottom:1px solid #ddd;">
    <button onclick="drawMaster()">MASTER VIEW</button> | 
    <select id="selStream" onchange="drawIndiv('stream')"><option value="">Streams</option></select>
    <select id="selTeacher" onchange="drawIndiv('teacher')"><option value="">Teachers</option></select>
</div>

<div id="mainDisplay"></div>

<script>
let RAW = [], DATA = [], TIME = [], LOGO = null, FAILURES = [];
const DAYS = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"];

function loadLogo(e) {
    const reader = new FileReader();
    reader.onload = (r) => { LOGO = r.target.result; document.getElementById('logoBox').innerHTML = `<img src="${LOGO}">`; };
    reader.readAsDataURL(e.target.files[0]);
}

function readCSV(e) {
    const reader = new FileReader();
    reader.onload = (r) => {
        const rows = r.target.result.split('\n').slice(1);
        RAW = rows.filter(l => l.trim()).map(l => {
            const c = l.split(',');
            return { sub: c[0]?.trim().toUpperCase(), tea: c[1]?.trim(), frm: c[3]?.trim().toUpperCase() };
        });
        document.getElementById('status').innerText = "LOADED: " + RAW.length + " LESSONS";
        document.getElementById('status').style.color = "green";
    };
    reader.readAsText(e.target.files[0]);
}

function getSpec(d, p) {
    if (d === "WEDNESDAY" && (p === "P8" || p === "P9")) return "RELIGION";
    if (d === "THURSDAY" && (p === "P8" || p === "P9")) return "DEBATE";
    if (d === "FRIDAY" && (p === "P7" || p === "P8" || p === "P9")) return "MOSQUE";
    return null;
}

function runGenerator() {
    if(RAW.length === 0) { alert("Please upload a CSV first."); return; }
    
    // --- RESET DATA FOR RESCHEDULE ---
    DATA = []; FAILURES = []; TIME = [];
    
    const count = parseInt(document.getElementById('tCount').value);
    const dur = parseInt(document.getElementById('tDur').value);
    let curr = new Date("2026-01-01T" + document.getElementById('tTime').value);

    for(let i=1; i<=count; i++) {
        let s = curr.toTimeString().slice(0,5);
        curr.setMinutes(curr.getMinutes() + dur);
        TIME.push({ p: 'P'+i, t: s + '-' + curr.toTimeString().slice(0,5), isB: false });
        if(i === 4) { // Break after P4
            let bs = curr.toTimeString().slice(0,5);
            curr.setMinutes(curr.getMinutes() + 30);
            TIME.push({ p: 'BREAK', t: bs + '-' + curr.toTimeString().slice(0,5), isB: true });
        }
    }

    const groups = RAW.reduce((acc, obj) => {
        const key = obj.frm + '-' + obj.sub;
        if(!acc[key]) acc[key] = [];
        acc[key].push(obj);
        return acc;
    }, {});

    // --- DOUBLE PRIORITY ENGINE ---
    Object.values(groups).forEach(lessons => {
        let left = lessons.length;
        
        // Pass 1: Doubles (Priority)
        while(left >= 2) {
            let placed = false;
            // Valid start indices: P1, P2, P3, P5, P6, P7 (Skips P4 to avoid break)
            const doubleStartIndices = [0, 1, 2, 5, 6, 7]; 
            for(let sIdx of doubleStartIndices) {
                for(let d of DAYS) {
                    const p1 = 'P'+(sIdx+1), p2 = 'P'+(sIdx+2);
                    if(check(d, p1, lessons[0]) && check(d, p2, lessons[0])) {
                        DATA.push({...lessons[0], d, p: p1}, {...lessons[0], d, p: p2});
                        left -= 2; placed = true; break;
                    }
                }
                if(placed) break;
            }
            if(!placed) break; 
        }

        // Pass 2: Singles (Fill gaps like P5)
        while(left > 0) {
            let placed = false;
            for(let sIdx=0; sIdx < count; sIdx++) {
                for(let d of DAYS) {
                    const p = 'P'+(sIdx+1);
                    if(check(d, p, lessons[0])) {
                        DATA.push({...lessons[0], d, p: p});
                        left--; placed = true; break;
                    }
                }
                if(placed) break;
            }
            if(!placed) { FAILURES.push(lessons[0]); left--; }
        }
    });

    document.getElementById('viewBar').style.display = 'block';
    populateDropdowns();
    drawMaster();
}

function check(d, p, l) {
    if(getSpec(d, p)) return false;
    // Check teacher or stream booking
    return !DATA.some(x => x.d === d && x.p === p && (x.tea === l.tea || x.frm === l.frm));
}

function populateDropdowns() {
    const fList = [...new Set(DATA.map(x => x.frm))].sort();
    const tList = [...new Set(DATA.map(x => x.tea))].sort();
    document.getElementById('selStream').innerHTML = '<option value="">Streams</option>' + fList.map(f => `<option>${f}</option>`).join('');
    document.getElementById('selTeacher').innerHTML = '<option value="">Teachers</option>' + tList.map(t => `<option>${t}</option>`).join('');
}

function drawMaster() {
    let h = `<h2>MASTER TIMETABLE</h2>`;
    const frms = [...new Set(DATA.map(x => x.frm))].sort();
    DAYS.forEach(day => {
        h += `<div class="day-section"><div class="day-title">${day}</div><table><tr><th>STRM</th>`;
        TIME.forEach(tp => h += tp.isB ? `<th class="break-cell"></th>` : `<th>${tp.p}<br><small>${tp.t}</small></th>`);
        h += `</tr>`;
        frms.forEach((f, idx) => {
            h += `<tr><td><b>${f}</b></td>`;
            TIME.forEach(tp => {
                const sp = getSpec(day, tp.p);
                if(tp.isB) { if(idx===0) h+=`<td class="break-cell" rowspan="${frms.length}"><span class="vertical-text">BREAK</span></td>`; }
                else if(sp) { if(idx===0) h+=`<td class="spec-merged" rowspan="${frms.length}"><span class="vertical-text">${sp}</span></td>`; }
                else {
                    const m = DATA.find(x => x.d === day && x.p === tp.p && x.frm === f);
                    h += `<td>${m ? `<b>${m.sub}</b><br>${m.tea}` : ''}</td>`;
                }
            });
            h += `</tr>`;
        });
        h += `</table></div>`;
    });
    document.getElementById('mainDisplay').innerHTML = h;
}

function drawLoad() {
    const list = [...new Set(RAW.map(x => x.tea))].sort();
    let h = `<h2>LOAD ANALYSIS</h2><table style="width:70%; margin:auto;"><tr><th>TEACHER</th><th>REQ</th><th>GOT</th><th>STATUS</th></tr>`;
    list.forEach(t => {
        const target = RAW.filter(x => x.tea === t).length;
        const got = DATA.filter(x => x.tea === t).length;
        const status = got === target ? '✅' : '❌ Missing ' + (target - got);
        h += `<tr><td>${t}</td><td>${target}</td><td>${got}</td><td>${status}</td></tr>`;
    });
    document.getElementById('mainDisplay').innerHTML = h + `</table>`;
}

function drawIndiv(type) {
    const val = document.getElementById(type === 'stream' ? 'selStream' : 'selTeacher').value;
    if(!val) return;
    let h = `<h2>${val}</h2><table><tr><th>DAY</th>` + TIME.map(tp => tp.isB ? `<th class="break-cell"></th>` : `<th>${tp.p}</th>`).join('') + `</tr>`;
    DAYS.forEach(d => {
        h += `<tr><td><b>${d}</b></td>`;
        TIME.forEach(tp => {
            const sp = getSpec(d, tp.p);
            if(tp.isB) h += `<td class="break-cell">BRK</td>`;
            else if(sp) h += `<td class="spec-merged">${sp}</td>`;
            else {
                const m = DATA.find(x => x.d === d && x.p === tp.p && (type==='stream'? x.frm===val : x.tea===val));
                h += `<td>${m ? `<b>${m.sub}</b><br>${type==='stream'?m.tea:m.frm}` : ''}</td>`;
            }
        });
        h += `</tr>`;
    });
    document.getElementById('mainDisplay').innerHTML = h + `</table>`;
}
</script>
</body>
</html>
