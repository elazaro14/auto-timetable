<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Timetable - Compact + Teacher Conflict Detection</title>
<style>
    body {
        font-family: Arial, Helvetica, sans-serif;
        background: #f8f9fa;
        margin: 0;
        padding: 12px;
        color: #222;
    }
    .container { max-width: 1380px; margin: 0 auto; }

    .panel {
        background: white;
        padding: 14px;
        border-radius: 8px;
        box-shadow: 0 1px 6px rgba(0,0,0,0.08);
        margin-bottom: 18px;
    }

    button, input, select {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 5px;
        border: 1px solid #ccc;
        margin: 3px;
    }

    .master-timetable {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
        background: white;
        margin: 10px 0 20px;
        line-height: 1.15;
    }

    th, td {
        border: 1px solid #666;
        padding: 3px 4px;
        text-align: center;
        height: 26px;
    }

    th {
        background: #2c3e50;
        color: white;
        font-weight: normal;
        font-size: 9.5px;
    }

    .break-cell {
        background: #f1f3f5;
        color: #444;
        font-weight: bold;
        font-size: 9px;
        width: 60px;
    }

    .fixed {
        background: #e3f2fd;
        color: #0d47a1;
        font-weight: bold;
        font-size: 9px;
    }

    .group-separator td {
        background: #ffcc00;
        height: 5px;
        padding: 0;
        border: none;
    }

    .day-title {
        background: #34495e;
        color: white;
        padding: 8px;
        font-size: 1.2em;
        margin: 18px 0 6px;
        text-align: center;
        border-radius: 5px;
    }

    .form-col {
        font-weight: bold;
        width: 52px;
        font-size: 10.5px;
    }

    .time-small {
        font-size: 8px;
        color: #ddd;
        display: block;
        margin-top: 1px;
    }

    .lesson-subject { font-size: 10px; }
    .lesson-teacher {
        font-size: 8.5px;
        color: #444;
        display: block;
        margin-top: 1px;
    }

    @media print {
        .panel { display: none; }
        body { padding: 0; margin: 0; }
        .master-timetable { page-break-inside: avoid; }
        .day-title { page-break-before: always; margin-top: 0; }
    }
</style>
</head>
<body>

<div class="panel container">
    <h2 style="margin:0 0 12px 0; text-align:center">School Timetable Generator</h2>

    <div style="text-align:center; margin:12px 0;">
        <input id="school" placeholder="School Name" style="width:220px">
        <input id="year" placeholder="Year" style="width:100px">
        <select id="display">
            <option value="subject">Subject only</option>
            <option value="full" selected>Subject + Teacher</option>
        </select>
    </div>

    <div style="text-align:center;">
        <button onclick="document.getElementById('csv').click()" class="blue">Upload CSV</button>
        <input type="file" id="csv" accept=".csv" hidden onchange="loadCSV(event)">
        <button onclick="generate()" class="green" id="genBtn" disabled>Generate</button>
        <button onclick="window.print()" class="gray">Print</button>
    </div>

    <p id="status" style="margin-top:12px; font-weight:bold; text-align:center">
        Upload lesson demand CSV (Subject,Teacher,Room,Form) to begin...
    </p>
</div>

<div class="container" id="output"></div>

<script>
const DAYS = ["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY"];
const PERIODS = [
    {c:"P1",t:"8:00-8:40"},{c:"P2",t:"8:40-9:20"},{c:"P3",t:"9:20-10:00"},
    {c:"P4",t:"10:00-10:40"},{c:"BREAK",t:"10:40-11:10"},
    {c:"P5",t:"11:10-11:50"},{c:"P6",t:"11:50-12:30"},{c:"P7",t:"12:30-13:10"},
    {c:"P8",t:"13:10-13:50"},{c:"P9",t:"13:50-14:30"}
];

const DOUBLE_PAIRS = [
    ['P1','P2'],['P2','P3'],['P3','P4'],
    ['P5','P6'],['P6','P7'],['P7','P8'],['P8','P9']
];

let lessonsDemand = [];
let timetable = [];

function isFixed(day, p) {
    if (day === "WEDNESDAY" && ["P8","P9"].includes(p)) return "RELIGION";
    if (day === "FRIDAY" && ["P7","P8","P9"].includes(p)) return "MOSQUE";
    return null;
}

function loadCSV(e) {
    const file = e.target.files[0];
    if (!file) return;

    const r = new FileReader();
    r.onload = () => {
        lessonsDemand = r.result.split("\n").slice(1)
            .map(l=>l.trim())
            .filter(l=>l)
            .map(l=>{
                const [sub, tea,, frm] = l.split(",").map(x=>x.trim());
                return {subject:sub, teacher:tea||null, form:frm};
            })
            .filter(l => l.subject && l.form);

        document.getElementById("genBtn").disabled = false;
        document.getElementById("status").innerText = 
            `Loaded ${lessonsDemand.length} periods • ${new Set(lessonsDemand.map(l=>l.form)).size} classes`;
    };
    r.readAsText(file);
}

function generate() {
    if (!lessonsDemand.length) return alert("Please upload CSV first!");

    timetable = [];

    // Track used slots
    const classUsed  = {}; // form → day → period → true
    const teacherUsed = {}; // teacher → day → period → true

    lessonsDemand.forEach(l=>{
        if(!classUsed[l.form]) classUsed[l.form] = {};
        DAYS.forEach(d=>{if(!classUsed[l.form][d]) classUsed[l.form][d] = {}});
    });

    // Group by form + subject (to prefer doubles)
    const groups = {};
    lessonsDemand.forEach(l=>{
        const key = `${l.form}|${l.subject}`;
        if(!groups[key]) groups[key] = [];
        groups[key].push(l);
    });

    Object.values(groups).forEach(group => {
        const form = group[0].form;
        const subject = group[0].subject;
        const teacher = group[0].teacher; // can be null
        let remaining = group.length;

        // Phase 1: Try to place doubles
        while (remaining >= 2) {
            let placed = false;
            for (const day of DAYS) {
                for (const [p1, p2] of DOUBLE_PAIRS) {
                    const slot1Free = !classUsed[form][day][p1] && !isFixed(day, p1);
                    const slot2Free = !classUsed[form][day][p2] && !isFixed(day, p2);

                    let teacherFree = true;
                    if (teacher) {
                        teacherFree = 
                            (!teacherUsed[teacher]?.[day]?.[p1]) &&
                            (!teacherUsed[teacher]?.[day]?.[p2]);
                    }

                    if (slot1Free && slot2Free && teacherFree) {
                        timetable.push({form, subject, teacher, day, period: p1});
                        timetable.push({form, subject, teacher, day, period: p2});

                        classUsed[form][day][p1] = true;
                        classUsed[form][day][p2] = true;

                        if (teacher) {
                            if (!teacherUsed[teacher]) teacherUsed[teacher] = {};
                            if (!teacherUsed[teacher][day]) teacherUsed[teacher][day] = {};
                            teacherUsed[teacher][day][p1] = true;
                            teacherUsed[teacher][day][p2] = true;
                        }

                        remaining -= 2;
                        placed = true;
                        break;
                    }
                }
                if (placed) break;
            }
            if (!placed) break; // no more possible doubles
        }

        // Phase 2: Place remaining as singles
        while (remaining > 0) {
            let placed = false;
            for (const day of DAYS) {
                for (const p of PERIODS.map(pp => pp.c).filter(c => c !== "BREAK")) {
                    const slotFree = !classUsed[form][day][p] && !isFixed(day, p);

                    let teacherOk = true;
                    if (teacher) {
                        teacherOk = !teacherUsed[teacher]?.[day]?.[p];
                    }

                    if (slotFree && teacherOk) {
                        timetable.push({form, subject, teacher, day, period: p});

                        classUsed[form][day][p] = true;

                        if (teacher) {
                            if (!teacherUsed[teacher]) teacherUsed[teacher] = {};
                            if (!teacherUsed[teacher][day]) teacherUsed[teacher][day] = {};
                            teacherUsed[teacher][day][p] = true;
                        }

                        remaining--;
                        placed = true;
                        break;
                    }
                }
                if (placed) break;
            }
            if (!placed) {
                console.warn(`Could not place all ${remaining} lessons for ${form} - ${subject}`);
                break;
            }
        }
    });

    renderCompactDayLayout();
    document.getElementById("status").innerText = 
        `Generated • ${timetable.length}/${lessonsDemand.length} periods placed (teacher conflicts prevented)`;
}

function renderCompactDayLayout() {
    const output = document.getElementById("output");
    output.innerHTML = "";

    const school = document.getElementById("school").value.trim() || "School";
    const year   = document.getElementById("year").value.trim()   || "2026";
    const mode   = document.getElementById("display").value;

    output.innerHTML += `<h2 style="text-align:center;margin-bottom:8px">${school} – ${year}</h2>`;

    const allForms = [...new Set(lessonsDemand.map(l => l.form))].sort();

    DAYS.forEach(day => {
        output.innerHTML += `<div class="day-title">${day}</div>`;

        let html = `
        <table class="master-timetable">
        <thead>
            <tr>
                <th rowspan="2" class="form-col">FORM</th>
                <th colspan="4">MORNING</th>
                <th rowspan="2" class="break-cell">BREAK</th>
                <th colspan="5">AFTERNOON</th>
            </tr>
            <tr>`;

        PERIODS.forEach(p => {
            if (p.c === "BREAK") return;
            html += `<th>${p.c}<span class="time-small">${p.t}</span></th>`;
        });

        html += `</tr></thead><tbody>`;

        let prevLevel = "";
        allForms.forEach(form => {
            const level = form.slice(0,2);
            if (level !== prevLevel) {
                if (prevLevel) html += `<tr class="group-separator"><td colspan="11"></td></tr>`;
                prevLevel = level;
            }

            html += `<tr><td class="form-col"><b>${form}</b></td>`;

            PERIODS.forEach(per => {
                if (per.c === "BREAK") {
                    html += `<td class="break-cell">BREAK</td>`;
                    return;
                }

                const fixed = isFixed(day, per.c);
                if (fixed) {
                    html += `<td class="fixed">${fixed}</td>`;
                    return;
                }

                const lesson = timetable.find(l => 
                    l.form === form && l.day === day && l.period === per.c
                );

                if (lesson) {
                    if (mode === "full" && lesson.teacher) {
                        html += `<td><span class="lesson-subject">${lesson.subject}</span><span class="lesson-teacher">${lesson.teacher}</span></td>`;
                    } else {
                        html += `<td><span class="lesson-subject">${lesson.subject}</span></td>`;
                    }
                } else {
                    html += `<td></td>`;
                }
            });

            html += `</tr>`;
        });

        html += `</tbody></table>`;
        output.innerHTML += html;
    });
}
</script>
</body>
</html>
